<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Santa Tracker 2014 - Remake Fiel</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700;900&family=Lobster&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    
    <script>
        function handleImgLoad(img) {
            img.style.display = 'block';
            const fallback = img.parentElement.querySelector('.css-house');
            if(fallback) fallback.style.display = 'none';
            recalcScrollLimits();
        }
        function handleImgError(img) {
            img.style.display = 'none';
            const fallback = img.parentElement.querySelector('.css-house');
            if(fallback) fallback.style.display = 'block';
        }
    </script>
</head>
<body>

    <!-- Header & Countdown -->
    <div class="header">
        <div class="google-logo">Google</div>
        <h1 class="title">Santa Tracker</h1>
        
        <div class="countdown-container">
            <div class="countdown-timers">
                <div class="timer-block">
                    <div class="timer-number" id="d">00</div>
                    <div class="timer-label">Días</div>
                </div>
                <div class="timer-block">
                    <div class="timer-number" id="h">00</div>
                    <div class="timer-label">Hrs</div>
                </div>
                <div class="timer-block">
                    <div class="timer-number" id="m">00</div>
                    <div class="timer-label">Min</div>
                </div>
                <div class="timer-block">
                    <div class="timer-number" id="s">00</div>
                    <div class="timer-label">Seg</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Escenario -->
    <div id="village-wrapper">
        <div class="layer">
            <!-- Cielo: Sol, Luna, Avión, Nubes -->
            <img id="sun" src="assets/sun.png" alt="Sol">
            <img id="moon" src="assets/moon.png" alt="Luna">
            <img id="plane" src="assets/plane.png" alt="Avión">
            
            <div id="clouds">
                <div class="cloud" style="left: 10%; top: 50px;"></div>
                <div class="cloud" style="left: 50%; top: 20px; width:180px;"></div>
                <div class="cloud" style="left: 80%; top: 80px;"></div>
            </div>
        </div>

        <div id="mountains" class="layer">
            <div class="mountain-shape" style="left: -50px; border-bottom-color: #b2ebf2;"></div>
            <div class="mountain-shape" style="left: 20%; transform: scale(1.5); z-index: -1;"></div>
            <div class="mountain-shape" style="left: 50%; border-bottom-color: #b2ebf2;"></div>
            <div class="mountain-shape" style="left: 80%; transform: scale(1.2);"></div>
        </div>

        <!-- Capa de Árboles (Parallax) -->
        <div id="trees"></div>

        <div id="rail" class="layer">
            <!-- Ferry en lugar de tren -->
            <img id="ferry" src="assets/ferry.png" alt="Ferry">
        </div>

        <div id="village-track">
            <!-- JS -->
        </div>

        <div id="ground" class="layer"></div>
    </div>

    <!-- Navegación con Imágenes -->
    <div class="nav-btn prev-btn" onmousedown="startScroll(1)" onmouseup="stopScroll()" onmouseleave="stopScroll()"></div>
    <div class="nav-btn next-btn" onmousedown="startScroll(-1)" onmouseup="stopScroll()" onmouseleave="stopScroll()"></div>

    <script>
        const track = document.getElementById('village-track');
        const spriteOrder = [1, 2, 3, 21, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 4, 22, 23];
        const markerWidth = 110; 
        const simulatedCurrentDay = 12; 

        // Generar Casas
        for (let i = 1; i <= 24; i++) {
            const wrapper = document.createElement('div');
            wrapper.className = 'house-container';

            const spriteIndex = spriteOrder.indexOf(i);
            const safeSpriteIndex = spriteIndex !== -1 ? spriteIndex : 22; 
            const markerBgX = -(safeSpriteIndex * markerWidth);
            const isUnlocked = i <= simulatedCurrentDay;
            
            let markerClass = isUnlocked ? 'marker unlocked' : 'marker locked';
            let markerBgY = isUnlocked ? 0 : -176; 
            let titleText = `Casa ${i}`;

            let elvesHTML = '';
            const numElves = Math.floor(Math.random() * 3) + 1;
            
            for(let e = 0; e < numElves; e++) {
                const elfIndex = Math.floor(Math.random() * 33);
                const elfWidth = 65; 
                const elfBgX = -(elfIndex * elfWidth);
                const randomOffset = Math.floor(Math.random() * 200) - 100;
                const randomBottom = Math.floor(Math.random() * 20) - 10;
                
                elvesHTML += `<div class="elf" style="background-position: ${elfBgX}px 0; left: 50%; margin-left: ${randomOffset}px; bottom: ${randomBottom}px;"></div>`;
            }

            wrapper.innerHTML = `
                <div class="${markerClass}" 
                     style="background-position: ${markerBgX}px ${markerBgY}px;" 
                     title="${titleText}">
                </div>
                ${elvesHTML}
                <img src="assets/house_${i}_snow.png" class="snow-layer" onload="this.style.display='block'" onerror="this.style.display='none'">
                <img src="assets/house_${i}.png" class="house-layer" onload="handleImgLoad(this)" onerror="handleImgError(this)">
                <div class="css-house" style="display:none;"><div class="css-snow-behind"></div></div>
            `;
            track.appendChild(wrapper);
        }

        // --- AUDIO ---
        let audioStarted = false;
        const bgm = new Audio('/audio/village_theme.mp3');
        bgm.loop = true;
        bgm.volume = 0.5;

        const startAudio = () => {
            if (!audioStarted) {
                bgm.play().then(() => {
                    audioStarted = true;
                    document.removeEventListener('click', startAudio);
                    document.removeEventListener('keydown', startAudio);
                }).catch(e => console.log("Audio waiting", e));
            }
        };
        document.addEventListener('click', startAudio);
        document.addEventListener('keydown', startAudio);

        // --- SCROLL LÓGICO ---
        let currentX = 0;
        let targetX = 0;
        let isScrolling = 0;
        let animFrame;
        const minScroll = 0; 
        let maxScroll = -5000; 

        function recalcScrollLimits() {
            const trackWidth = track.scrollWidth;
            const viewportWidth = window.innerWidth;
            maxScroll = -(trackWidth - viewportWidth);
        }

        window.addEventListener('load', recalcScrollLimits);
        window.addEventListener('resize', recalcScrollLimits);
        setTimeout(recalcScrollLimits, 1000);

        function startScroll(dir) {
            isScrolling = dir;
            if (!animFrame) updateScroll();
        }
        function stopScroll() { isScrolling = 0; }

        function updateScroll() {
            if (isScrolling !== 0) {
                targetX += isScrolling * 25; 
                if (targetX > minScroll) targetX = minScroll;
                if (targetX < maxScroll) targetX = maxScroll;
            }
            
            currentX += (targetX - currentX) * 0.1;
            
            if (Math.abs(targetX - currentX) < 0.5 && isScrolling === 0) {
                currentX = targetX;
            }

            track.style.transform = `translateX(${currentX}px)`;
            
            // Parallax Effects
            const mountainX = currentX * 0.2;
            const treeX = currentX * 0.5; // Los árboles se mueven más rápido que las montañas
            
            document.getElementById('mountains').style.transform = `translateX(${mountainX}px)`;
            document.getElementById('trees').style.transform = `translateX(${treeX}px)`;

            if (isScrolling !== 0 || Math.abs(targetX - currentX) >= 0.5) {
                animFrame = requestAnimationFrame(updateScroll);
            } else {
                animFrame = null;
            }
        }

        function updateTimer() {
            const now = new Date();
            let xmas = new Date(now.getFullYear(), 11, 25);
            if (now > xmas) xmas.setFullYear(xmas.getFullYear() + 1);

            const diff = xmas - now;
            const d = Math.floor(diff / (1000 * 60 * 60 * 24));
            const h = Math.floor((diff / (1000 * 60 * 60)) % 24);
            const m = Math.floor((diff / 1000 / 60) % 60);
            const s = Math.floor((diff / 1000) % 60);

            document.getElementById('d').innerText = String(d).padStart(2, '0');
            document.getElementById('h').innerText = String(h).padStart(2, '0');
            document.getElementById('m').innerText = String(m).padStart(2, '0');
            document.getElementById('s').innerText = String(s).padStart(2, '0');
        }
        setInterval(updateTimer, 1000);
        updateTimer();
    </script>
</body>
</html>