<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Santa Tracker 2014</title>

    <link rel="icon" type="image/x-icon" href="assets/favicon.ico">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700;900&family=Lobster&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">

    <script>
        function handleImgLoad(img) {
            img.style.display = 'block';
            const fallback = img.parentElement.querySelector('.css-house');
            if(fallback) fallback.style.display = 'none';
            if(window.recalcScrollLimits) window.recalcScrollLimits();
        }
        function handleImgError(img) {
            img.style.display = 'none';
            const fallback = img.parentElement.querySelector('.css-house');
            if(fallback) fallback.style.display = 'block';
        }
    </script>
</head>
<body>

    <div class="header">
        <div class="google-logo">Google</div>
        <h1 class="title">Santa Tracker</h1>

        <div class="countdown-container">
            <div class="countdown-timers">
                <div class="timer-block">
                    <div class="timer-number" id="d">00</div>
                    <div class="timer-label">Días</div>
                </div>
                <div class="timer-block">
                    <div class="timer-number" id="h">00</div>
                    <div class="timer-label">Hrs</div>
                </div>
                <div class="timer-block">
                    <div class="timer-number" id="m">00</div>
                    <div class="timer-label">Min</div>
                </div>
                <div class="timer-block">
                    <div class="timer-number" id="s">00</div>
                    <div class="timer-label">Seg</div>
                </div>
            </div>
        </div>
    </div>

    <div id="village-wrapper">
        <div class="layer" id="sky-layer">
            <img id="sun" src="assets/sun.png" alt="Sol">
            <img id="moon" src="assets/moon.png" alt="Luna">
            <img id="plane" src="assets/plane.png" alt="Avión">

            <div id="clouds">
                <div class="cloud" style="left: 10%; top: 50px;"></div>
                <div class="cloud" style="left: 50%; top: 20px; width:180px;"></div>
                <div class="cloud" style="left: 80%; top: 80px;"></div>
            </div>
        </div>

        <div id="mountains" class="layer">
            <div class="mountain-shape" style="left: -50px; border-bottom-color: #b2ebf2;"></div>
            <div class="mountain-shape" style="left: 20%; transform: scale(1.5); z-index: -1;"></div>
            <div class="mountain-shape" style="left: 50%; border-bottom-color: #b2ebf2;"></div>
            <div class="mountain-shape" style="left: 80%; transform: scale(1.2);"></div>
        </div>

        <div id="trees"></div>

        <div id="rail" class="layer">
            <img id="ferry" src="assets/ferry.png" alt="Ferry">
        </div>

        <div id="village-track">
            <!-- Las casas se generarán aquí mediante JS -->
        </div>

        <div id="bus-container"></div>

        <div id="ground" class="layer"></div>
    </div>

    <div class="nav-btn prev-btn" onmousedown="startScroll(1)" onmouseup="stopScroll()" onmouseleave="stopScroll()"></div>
    <div class="nav-btn next-btn" onmousedown="startScroll(-1)" onmouseup="stopScroll()" onmouseleave="stopScroll()"></div>

    <script>
        // --- VARIABLES DE ESTADO ---
        var currentX = 0;
        var targetX = 0;
        var isScrolling = 0;
        var animFrame = null;
        var minScroll = 0; 
        var maxScroll = -5000; 

        // --- Configuración e Inicialización ---
        const track = document.getElementById('village-track');
        const spriteOrder = [1, 2, 3, 21, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 4, 22, 23];
        const markerWidth = 110; 
        
        // --- CÁLCULO DEL DÍA ACTUAL ---
        const now = new Date();
        const currentMonth = now.getMonth(); // 0 = Enero, 11 = Diciembre
        const currentDayOfMonth = now.getDate();
        
        let activeDay = 1; // Por defecto al día 1
        
        if (currentMonth === 11) {
            // Si es diciembre, el día activo es el día de hoy (tope 24, aunque solo dibujaremos hasta el 23)
            activeDay = currentDayOfMonth > 24 ? 24 : currentDayOfMonth;
        } else if (currentMonth > 11) {
             activeDay = 24;
        } else {
             activeDay = 1;
        }

        // --- CARGA DE DATOS Y GENERACIÓN DE CASAS ---
        fetch('games.json')
            .then(response => {
                if (!response.ok) {
                    throw new Error("No se pudo cargar games.json");
                }
                return response.json();
            })
            .then(gamesData => {
                // Crear un mapa para acceso rápido por número de día
                const gamesMap = {};
                gamesData.forEach(game => {
                    gamesMap[game.numero] = game;
                });

                // Generar Casas (1 a 23) - CAMBIO AQUÍ: antes era <= 24
                for (let i = 1; i <= 23; i++) {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'house-container';
                    wrapper.id = `house-${i}`; 

                    const spriteIndex = spriteOrder.indexOf(i);
                    const safeSpriteIndex = spriteIndex !== -1 ? spriteIndex : 22; 
                    const markerBgX = -(safeSpriteIndex * markerWidth);
                    
                    // Lógica de desbloqueo: Solo si i <= activeDay
                    const isUnlocked = i <= activeDay;

                    // Datos del JSON
                    const gameInfo = gamesMap[i];
                    const gameUrl = gameInfo ? gameInfo.enlace : '#';
                    const gameName = gameInfo ? gameInfo.nombre : `Día ${i}`;

                    // Lógica visual: Bloqueados (abajo) vs Desbloqueados (arriba)
                    let markerClass = isUnlocked ? 'marker unlocked' : 'marker locked';
                    let markerBgY = isUnlocked ? 0 : -176; 
                    
                    // HTML de Elfos
                    let elvesHTML = '';
                    const numElves = Math.floor(Math.random() * 6) + 1;

                    for(let e = 0; e < numElves; e++) {
                        const elfNum = Math.floor(Math.random() * 17) + 1;
                        const randomOffset = Math.floor(Math.random() * 800) - 100;
                        const randomBottom = Math.floor(Math.random() * 50) - 0;
                        elvesHTML += `<img src="elves/elf_${elfNum}.png" class="elf" alt="Elfo" style="left: 50%; margin-left: ${randomOffset}px; bottom: ${randomBottom}px;">`;
                    }

                    // Construir el HTML
                    wrapper.innerHTML = `
                        <div class="${markerClass}" 
                             style="background-position: ${markerBgX}px ${markerBgY}px;" 
                             title="${gameName}"></div>
                        ${elvesHTML}
                        <img src="assets/house_${i}_snow.png" class="snow-layer" onload="this.style.display='block'" onerror="this.style.display='none'">
                        <img src="assets/house_${i}.png" class="house-layer" onload="handleImgLoad(this)" onerror="handleImgError(this)">
                        <div class="css-house" style="display:none;"><div class="css-snow-behind"></div></div>
                    `;

                    // Lógica de Click
                    const markerDiv = wrapper.querySelector('.marker');
                    
                    if (isUnlocked) {
                        if (gameUrl !== '#') {
                            markerDiv.addEventListener('click', () => {
                                window.location.href = gameUrl;
                            });
                        }
                        markerDiv.style.cursor = 'pointer';
                    } else {
                        markerDiv.style.cursor = 'default';
                    }

                    track.appendChild(wrapper);
                }

                // Recalcular límites de scroll una vez que las casas existen
                window.recalcScrollLimits();

                // --- CENTRAR EN EL DÍA ACTUAL AL ENTRAR ---
                // Si hoy es día 24 o superior, intentará ir al último disponible (23)
                // ya que house-24 no existe.
                setTimeout(() => {
                    let targetDay = activeDay;
                    if (targetDay > 23) targetDay = 23; 
                    centerOnDay(targetDay);
                }, 100); 
            })
            .catch(error => {
                console.error("Error cargando los juegos:", error);
                track.innerHTML = "<p style='color:white; font-size:20px; padding:20px;'>Error: Necesitas un servidor local para cargar 'games.json' (CORS).</p>";
            });

        function centerOnDay(day) {
            const targetHouse = document.getElementById(`house-${day}`);
            if (!targetHouse) return; // Seguridad por si la casa no existe

            const viewportWidth = window.innerWidth;
            const houseLeft = targetHouse.offsetLeft;
            const houseWidth = targetHouse.offsetWidth;

            // Calculamos la posición X para que la casa quede en el centro de la pantalla
            let centerPos = -(houseLeft - (viewportWidth / 2) + (houseWidth / 2));

            // Respetamos los límites del scroll
            if (centerPos > minScroll) centerPos = minScroll;
            if (centerPos < maxScroll) centerPos = maxScroll;

            currentX = centerPos;
            targetX = centerPos;
            
            updateScrollVisuals();
        }

        // --- AUTOBUSES ---
        function spawnBus() {
            const viewportRightEdge = Math.abs(currentX) + window.innerWidth;
            const spawnX = viewportRightEdge + 200; 

            const bus = document.createElement('div');
            bus.className = 'bus';
            bus.style.left = spawnX + 'px';
            bus.style.transform = 'scaleX(-1)'; 

            track.appendChild(bus);

            // Reflow
            bus.offsetHeight; 

            // Movimiento hacia la izquierda
            bus.style.transform = `translateX(-${window.innerWidth + 800}px) scaleX(-1)`;

            bus.addEventListener('transitionend', () => {
                bus.remove();
            });
        }

        function startBusSpawner() {
             spawnBus();
             setTimeout(startBusSpawner, 4000 + Math.random() * 4000);
        }
        startBusSpawner();

        // --- AUDIO ---
        let audioStarted = false;
        const bgm = new Audio('audio/village_theme.mp3');
        bgm.loop = true;
        bgm.volume = 0.5;

        const startAudio = () => {
            if (!audioStarted) {
                bgm.play().then(() => {
                    audioStarted = true;
                    document.removeEventListener('click', startAudio);
                    document.removeEventListener('keydown', startAudio);
                }).catch(e => console.log("Audio waiting", e));
            }
        };
        document.addEventListener('click', startAudio);
        document.addEventListener('keydown', startAudio);

        // --- SCROLL FUNCTIONS ---
        window.recalcScrollLimits = function() {
            const trackWidth = track.scrollWidth;
            const viewportWidth = window.innerWidth;
            if (trackWidth === 0) return;
            
            maxScroll = -(trackWidth - viewportWidth);
        };

        window.addEventListener('load', window.recalcScrollLimits);
        window.addEventListener('resize', window.recalcScrollLimits);
        setTimeout(window.recalcScrollLimits, 1000);

        function startScroll(dir) {
            isScrolling = dir;
            if (!animFrame) updateScroll();
        }
        function stopScroll() { isScrolling = 0; }

        function updateScrollVisuals() {
            track.style.transform = `translateX(${currentX}px)`;

            const mountainX = currentX * 0.2;
            const treeX = currentX * 0.5;
            const groundX = currentX * 1.0;

            document.getElementById('mountains').style.transform = `translateX(${mountainX}px)`;
            document.getElementById('trees').style.transform = `translateX(${treeX}px)`;
            document.getElementById('ground').style.backgroundPositionX = `${groundX}px`;
        }

        function updateScroll() {
            if (isScrolling !== 0) {
                targetX += isScrolling * 25; 
                if (targetX > minScroll) targetX = minScroll;
                if (targetX < maxScroll) targetX = maxScroll;
            }

            currentX += (targetX - currentX) * 0.1;
            if (Math.abs(targetX - currentX) < 0.5 && isScrolling === 0) currentX = targetX;

            updateScrollVisuals();

            if (isScrolling !== 0 || Math.abs(targetX - currentX) >= 0.5) {
                animFrame = requestAnimationFrame(updateScroll);
            } else {
                animFrame = null;
            }
        }

        function updateTimer() {
            const now = new Date();
            const currentYear = now.getFullYear();
            let xmas = new Date(currentYear, 11, 24, 11, 0, 0);
            if (now > xmas) xmas.setFullYear(currentYear + 1);

            const diff = xmas - now;
            const d = Math.floor(diff / (1000 * 60 * 60 * 24));
            const h = Math.floor((diff / (1000 * 60 * 60)) % 24);
            const m = Math.floor((diff / 1000 / 60) % 60);
            const s = Math.floor((diff / 1000) % 60);

            document.getElementById('d').innerText = String(d).padStart(2, '0');
            document.getElementById('h').innerText = String(h).padStart(2, '0');
            document.getElementById('m').innerText = String(m).padStart(2, '0');
            document.getElementById('s').innerText = String(s).padStart(2, '0');
        }
        setInterval(updateTimer, 1000);
        updateTimer();
    </script>
</body>
</html>